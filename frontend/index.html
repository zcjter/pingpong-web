<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¹’ä¹“çƒæ¯”èµ›ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #f5f7fa;
        }

        .header {
            background: linear-gradient(135deg, #1a73e8, #4285f4);
            color: white;
            padding: 20px 40px;
        }

        .header h1 {
            font-size: 28px;
        }

        .nav {
            background: white;
            padding: 0 40px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-item {
            display: inline-block;
            padding: 15px 20px;
            cursor: pointer;
            color: #333;
            transition: all 0.3s;
        }

        .nav-item:hover,
        .nav-item.active {
            color: #1a73e8;
            border-bottom: 3px solid #1a73e8;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
        }

        .card-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .ranking-table {
            width: 100%;
            border-collapse: collapse;
        }

        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .ranking-table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .ranking-table tr:hover {
            background: #f8f9fa;
        }

        .rank-num {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            background: #eee;
            font-weight: bold;
        }

        .rank-1 .rank-num {
            background: #ffd700;
            color: white;
        }

        .rank-2 .rank-num {
            background: #c0c0c0;
            color: white;
        }

        .rank-3 .rank-num {
            background: #cd7f32;
            color: white;
        }

        .points {
            color: #1a73e8;
            font-weight: bold;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 5px;
        }

        .btn-primary {
            background: #1a73e8;
            color: white;
        }

        .btn-success {
            background: #34a853;
            color: white;
        }

        .btn-danger {
            background: #ea4335;
            color: white;
        }

        .btn-warning {
            background: #fbbc04;
            color: white;
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 25px;
            width: 90%;
            max-width: 700px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h3 {
            font-size: 18px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .announcement-item {
            padding: 15px;
            border-left: 4px solid #1a73e8;
            background: #f8f9fa;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .announcement-item:hover {
            background: #e8f0fe;
            transform: translateX(5px);
        }

        .announcement-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .announcement-date {
            font-size: 12px;
            color: #999;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .search-box {
            margin-bottom: 20px;
        }

        .search-box input {
            width: 300px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .competition-card {
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .competition-card:hover {
            background: #f8f9fa;
            border-color: #1a73e8;
        }

        .competition-info h4 {
            margin-bottom: 5px;
        }

        .competition-info p {
            font-size: 12px;
            color: #666;
            margin: 0;
        }

        .player-card {
            display: inline-block;
            width: 200px;
            padding: 15px;
            margin: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .player-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .player-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #1a73e8;
            color: white;
            line-height: 80px;
            font-size: 32px;
            margin: 0 auto 10px;
        }

        .player-name {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .player-country {
            font-size: 12px;
            color: #666;
        }

        .player-detail-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }

        .player-detail-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #1a73e8;
            color: white;
            line-height: 100px;
            font-size: 48px;
            margin-right: 20px;
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1a73e8;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
        }

        .back-btn {
            cursor: pointer;
            color: #1a73e8;
            margin-bottom: 15px;
            display: inline-block;
        }

        .announcement-detail {
            padding: 20px;
        }

        .announcement-content {
            line-height: 1.8;
            margin: 20px 0;
            white-space: pre-wrap;
        }

        .announcement-meta {
            color: #999;
            font-size: 14px;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .score-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .score-table th,
        .score-table td {
            padding: 8px;
            text-align: center;
            border: 1px solid #eee;
        }

        .score-table th {
            background: #f8f9fa;
        }

        .score-table .winner {
            color: #34a853;
            font-weight: bold;
            background: #e8f5e9;
        }

        .score-table .loser {
            color: #999;
        }

        .game-scores {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .game-score {
            padding: 2px 8px;
            background: #f0f0f0;
            border-radius: 4px;
            font-size: 12px;
        }

        .link-btn {
            background: none;
            border: none;
            color: #1a73e8;
            cursor: pointer;
            text-decoration: underline;
            padding: 0;
        }

        .link-btn:hover {
            color: #1557b0;
        }

        .score-input-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .score-input-row input {
            width: 60px;
            text-align: center;
        }

        .score-input-row span {
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="header">
        <h1>ğŸ“ ä¹’ä¹“çƒæ¯”èµ›ç®¡ç†ç³»ç»Ÿ</h1>
    </div>

    <div class="nav">
        <span class="nav-item active" data-page="home">é¦–é¡µ</span>
        <span class="nav-item" data-page="players">è‘—åè¿åŠ¨å‘˜</span>
        <span class="nav-item" data-page="competitions">èµ›äº‹ç®¡ç†</span>
        <span class="nav-item" data-page="ranking-manage">æ’åç®¡ç†</span>
        <span class="nav-item" data-page="champions">èµ›äº‹å† å†›</span>
    </div>

    <div class="container">
        <!-- é¦–é¡µ -->
        <div id="page-home">
            <div class="card">
                <div class="actions">
                    <div class="card-title">ğŸ“¢ æœ€æ–°å…¬å‘Š</div>
                    <button class="btn btn-primary" onclick="showAnnouncementModal()">+ æ·»åŠ å…¬å‘Š</button>
                </div>
                <div id="announcements-list"></div>
            </div>
            <div class="card">
                <div class="card-title">ğŸ† å®æ—¶æ’å TOP 3</div>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>å§“å</th>
                            <th>å›½å®¶</th>
                            <th>ç§¯åˆ†</th>
                        </tr>
                    </thead>
                    <tbody id="home-ranking"></tbody>
                </table>
            </div>
        </div>

        <!-- è‘—åè¿åŠ¨å‘˜ç®¡ç† -->
        <div id="page-players" style="display:none;">
            <div id="players-list-view">
                <div class="card">
                    <div class="actions">
                        <div class="card-title">ğŸ‘¥ è‘—åè¿åŠ¨å‘˜åˆ—è¡¨</div>
                        <button class="btn btn-primary" onclick="showPlayerModal()">+ æ·»åŠ è¿åŠ¨å‘˜</button>
                    </div>
                    <div class="search-box">
                        <input type="text" id="player-search" placeholder="æœç´¢è¿åŠ¨å‘˜..."
                            onkeyup="searchPlayers(this.value)">
                    </div>
                    <div id="players-grid"></div>
                </div>
            </div>
            <div id="player-detail-view" style="display:none;">
                <span class="back-btn" onclick="showPlayersList()">â† è¿”å›åˆ—è¡¨</span>
                <div class="card">
                    <div class="player-detail">
                        <div class="player-detail-header">
                            <div class="player-detail-avatar" id="detail-avatar"></div>
                            <div class="player-detail-info">
                                <h2 id="detail-name"></h2>
                                <p id="detail-country"></p>
                                <p id="detail-intro"></p>
                            </div>
                        </div>
                        <div class="player-stats">
                            <div class="stat-box">
                                <div class="stat-value" id="detail-age">-</div>
                                <div class="stat-label">å¹´é¾„</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="detail-gender">-</div>
                                <div class="stat-label">æ€§åˆ«</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="detail-points">0</div>
                                <div class="stat-label">ç§¯åˆ†</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="detail-rank">-</div>
                                <div class="stat-label">æ’å</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <button class="btn btn-warning" onclick="editPlayer(currentPlayerId)">ç¼–è¾‘</button>
                            <button class="btn btn-danger" onclick="deletePlayer(currentPlayerId)">åˆ é™¤</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- èµ›äº‹ç®¡ç† -->
        <div id="page-competitions" style="display:none;">
            <div id="competitions-list-view">
                <div class="card">
                    <div class="actions">
                        <div class="card-title">ğŸ† èµ›äº‹åˆ—è¡¨</div>
                        <button class="btn btn-primary" onclick="showCompetitionModal()">+ æ·»åŠ èµ›äº‹</button>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <select id="competition-year-select" onchange="filterCompetitions()"
                            style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                            <option value="">å…¨éƒ¨å¹´ä»½</option>
                        </select>
                    </div>
                    <div id="competitions-list"></div>
                </div>
            </div>
            <div id="competition-detail-view" style="display:none;">
                <span class="back-btn" onclick="showCompetitionsList()">â† è¿”å›èµ›äº‹åˆ—è¡¨</span>
                <div class="card">
                    <div class="actions">
                        <div class="card-title" id="competition-title"></div>
                        <button class="btn btn-primary" onclick="showMatchModal()">+ æ·»åŠ æ¯”èµ›</button>
                    </div>
                    <div id="competition-matches"></div>
                </div>
            </div>
        </div>

        <!-- æ’åç®¡ç† -->
        <div id="page-ranking-manage" style="display:none;">
            <div class="card">
                <div class="actions">
                    <div class="card-title">ğŸ“Š æ’åç®¡ç†</div>
                    <button class="btn btn-primary" onclick="showRankingModal()">+ æ·»åŠ æ’å</button>
                </div>
                <div style="margin-bottom: 15px; display: flex; gap: 10px;">
                    <select id="ranking-year-select" onchange="loadRankingsByFilter()"
                        style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">é€‰æ‹©å¹´ä»½</option>
                    </select>
                    <select id="ranking-category-select" onchange="loadRankingsByFilter()"
                        style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="">å…¨éƒ¨é¡¹ç›®</option>
                        <option value="ç”·å•">ç”·å•</option>
                        <option value="å¥³å•">å¥³å•</option>
                        <option value="ç”·åŒ">ç”·åŒ</option>
                        <option value="å¥³åŒ">å¥³åŒ</option>
                        <option value="æ··åŒ">æ··åŒ</option>
                        <option value="ç”·å›¢">ç”·å›¢</option>
                        <option value="å¥³å›¢">å¥³å›¢</option>
                    </select>
                </div>
                <div id="ranking-by-year"></div>
            </div>
        </div>

        <!-- èµ›äº‹å† å†› -->
        <div id="page-champions" style="display:none;">
            <div class="card">
                <div class="card-title">ğŸ† èµ›äº‹å† å†›æ¦œ</div>
                <div id="champions-competitions-list"></div>
            </div>
        </div>

        <!-- èµ›äº‹å† å†›è¯¦æƒ… -->
        <div id="page-champions-detail" style="display:none;">
            <span class="back-btn" onclick="showChampionsList()">â† è¿”å›èµ›äº‹åˆ—è¡¨</span>
            <div class="card">
                <div class="card-title" id="champions-competition-title"></div>
                <div id="champions-detail-content"></div>
            </div>
        </div>

        <!-- å…¬å‘Šè¯¦æƒ… -->
        <div id="page-announcement" style="display:none;">
            <span class="back-btn" onclick="showHome()">â† è¿”å›é¦–é¡µ</span>
            <div class="card">
                <div class="announcement-detail">
                    <h2 id="ann-title"></h2>
                    <div class="announcement-meta">
                        <span id="ann-type"></span> | <span id="ann-date"></span>
                    </div>
                    <div class="announcement-content" id="ann-content"></div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-warning" onclick="editAnnouncement(currentAnnouncementId)">ç¼–è¾‘</button>
                        <button class="btn btn-danger" onclick="deleteAnnouncement(currentAnnouncementId)">åˆ é™¤</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¿åŠ¨å‘˜æ¨¡æ€æ¡† -->
    <div id="player-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="player-modal-title">æ·»åŠ è¿åŠ¨å‘˜</h3>
                <button class="close-btn" onclick="closeModal('player-modal')">&times;</button>
            </div>
            <form id="player-form">
                <input type="hidden" id="player-id">
                <div class="form-group">
                    <label>å§“å *</label>
                    <input type="text" id="player-name" required>
                </div>
                <div class="form-group">
                    <label>å›½å®¶</label>
                    <input type="text" id="player-country">
                </div>
                <div class="form-group">
                    <label>å¹´é¾„</label>
                    <input type="number" id="player-age-input">
                </div>
                <div class="form-group">
                    <label>æ€§åˆ«</label>
                    <select id="player-gender">
                        <option value="ç”·">ç”·</option>
                        <option value="å¥³">å¥³</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>ç§¯åˆ†</label>
                    <input type="number" id="player-points" value="0">
                </div>
                <div class="form-group">
                    <label>ç®€ä»‹</label>
                    <textarea id="player-intro"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeModal('player-modal')">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <!-- èµ›äº‹æ¨¡æ€æ¡† -->
    <div id="competition-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="competition-modal-title">æ·»åŠ èµ›äº‹</h3>
                <button class="close-btn" onclick="closeModal('competition-modal')">&times;</button>
            </div>
            <form id="competition-form">
                <input type="hidden" id="competition-id">
                <div class="form-group">
                    <label>èµ›äº‹åç§° *</label>
                    <input type="text" id="competition-name" required>
                </div>
                <div class="form-group">
                    <label>å¹´ä»½ *</label>
                    <input type="number" id="competition-year" required value="2024">
                </div>
                <div class="form-group">
                    <label>åœ°ç‚¹</label>
                    <input type="text" id="competition-location">
                </div>
                <div class="form-group">
                    <label>å¼€å§‹æ—¥æœŸ</label>
                    <input type="date" id="competition-start">
                </div>
                <div class="form-group">
                    <label>ç»“æŸæ—¥æœŸ</label>
                    <input type="date" id="competition-end">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea id="competition-desc"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeModal('competition-modal')">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <!-- æ¯”èµ›æ¨¡æ€æ¡† -->
    <div id="match-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="match-modal-title">æ·»åŠ æ¯”èµ›</h3>
                <button class="close-btn" onclick="closeModal('match-modal')">&times;</button>
            </div>
            <form id="match-form">
                <input type="hidden" id="match-id">
                <div class="form-group">
                    <label>é€‰æ‰‹1 *</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="match-player1" list="player-suggestions" required autocomplete="off"
                            placeholder="è¾“å…¥é€‰æ‰‹å§“å" style="flex:1;">
                        <input type="text" id="match-player1-country" placeholder="å›½å®¶" style="width:100px;">
                    </div>
                </div>
                <div class="form-group">
                    <label>å±€æ•° (5å±€3èƒœæˆ–7å±€4èƒœ)</label>
                    <select id="match-games" onchange="renderScoreInputs()">
                        <option value="3">3å±€2èƒœ</option>
                        <option value="5" selected>5å±€3èƒœ</option>
                        <option value="7">7å±€4èƒœ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ¯å±€æ¯”åˆ†</label>
                    <div id="score-inputs-container"></div>
                </div>
                <div class="form-group">
                    <label>é€‰æ‰‹2 *</label>
                    <div style="display:flex; gap:10px;">
                        <input type="text" id="match-player2" list="player-suggestions" required autocomplete="off"
                            placeholder="è¾“å…¥é€‰æ‰‹å§“å" style="flex:1;">
                        <input type="text" id="match-player2-country" placeholder="å›½å®¶" style="width:100px;">
                    </div>
                </div>
                <datalist id="player-suggestions"></datalist>
                <div class="form-group">
                    <label>åœºé¦†</label>
                    <input type="text" id="match-venue">
                </div>
                <div class="form-group">
                    <label>æ¯”èµ›æ—¥æœŸ</label>
                    <input type="datetime-local" id="match-date">
                </div>
                <div class="form-group">
                    <label>çŠ¶æ€</label>
                    <select id="match-status">
                        <option value="scheduled">å·²å®‰æ’</option>
                        <option value="ongoing">è¿›è¡Œä¸­</option>
                        <option value="completed">å·²å®Œæˆ</option>
                        <option value="cancelled">å·²å–æ¶ˆ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>é¡¹ç›®ç±»åˆ«</label>
                    <select id="match-category">
                        <option value="ç”·å•">ç”·å•</option>
                        <option value="å¥³å•">å¥³å•</option>
                        <option value="ç”·åŒ">ç”·åŒ</option>
                        <option value="å¥³åŒ">å¥³åŒ</option>
                        <option value="æ··åŒ">æ··åŒ</option>
                        <option value="ç”·å›¢">ç”·å›¢</option>
                        <option value="å¥³å›¢">å¥³å›¢</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>è½®æ¬¡</label>
                    <input type="text" id="match-round" placeholder="å¦‚: 1/4å†³èµ›ã€åŠå†³èµ›ã€å†³èµ›">
                </div>
                <div class="form-group">
                    <label>å¤‡æ³¨</label>
                    <textarea id="match-remark"></textarea>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeModal('match-modal')">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <!-- å…¬å‘Šæ¨¡æ€æ¡† -->
    <div id="announcement-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="announcement-modal-title">æ·»åŠ å…¬å‘Š</h3>
                <button class="close-btn" onclick="closeModal('announcement-modal')">&times;</button>
            </div>
            <form id="announcement-form">
                <input type="hidden" id="announcement-id">
                <div class="form-group">
                    <label>æ ‡é¢˜ *</label>
                    <input type="text" id="announcement-title" required>
                </div>
                <div class="form-group">
                    <label>ç±»å‹</label>
                    <select id="announcement-type">
                        <option value="news">æ–°é—»</option>
                        <option value="notice">é€šçŸ¥</option>
                        <option value="system">ç³»ç»Ÿ</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>å†…å®¹ *</label>
                    <textarea id="announcement-content" rows="6" required></textarea>
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="announcement-published" checked> å‘å¸ƒ
                    </label>
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeModal('announcement-modal')">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <!-- æ’åæ¨¡æ€æ¡† -->
    <div id="ranking-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="ranking-modal-title">æ·»åŠ æ’å</h3>
                <button class="close-btn" onclick="closeModal('ranking-modal')">&times;</button>
            </div>
            <form id="ranking-form">
                <input type="hidden" id="ranking-id">
                <div class="form-group">
                    <label>å¹´ä»½ *</label>
                    <input type="number" id="ranking-year" required value="2024">
                </div>
                <div class="form-group">
                    <label>é¡¹ç›® *</label>
                    <select id="ranking-category" required>
                        <option value="ç”·å•">ç”·å•</option>
                        <option value="å¥³å•">å¥³å•</option>
                        <option value="ç”·åŒ">ç”·åŒ</option>
                        <option value="å¥³åŒ">å¥³åŒ</option>
                        <option value="æ··åŒ">æ··åŒ</option>
                        <option value="ç”·å›¢">ç”·å›¢</option>
                        <option value="å¥³å›¢">å¥³å›¢</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>æ’å *</label>
                    <input type="number" id="ranking-num" required value="1" min="1">
                </div>
                <div class="form-group">
                    <label>è¿åŠ¨å‘˜ *</label>
                    <input type="text" id="ranking-player-name" required autocomplete="off" placeholder="è¾“å…¥é€‰æ‰‹å§“å">
                </div>
                <div class="form-group">
                    <label>å›½å®¶</label>
                    <input type="text" id="ranking-country">
                </div>
                <div class="form-group">
                    <label>ç§¯åˆ† *</label>
                    <input type="number" id="ranking-points" required value="0">
                </div>
                <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                <button type="button" class="btn" onclick="closeModal('ranking-modal')">å–æ¶ˆ</button>
            </form>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:8090/api';
        let currentPlayerId = null;
        let currentCompetitionId = null;
        let currentAnnouncementId = null;
        let allPlayers = [];

        // å¯¼èˆª
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function () {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                const page = this.dataset.page;
                document.querySelectorAll('[id^="page-"]').forEach(p => p.style.display = 'none');
                document.getElementById('page-' + page).style.display = 'block';
                loadPageData(page);
            });
        });

        function showPage(page) {
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.querySelectorAll('[id^="page-"]').forEach(p => p.style.display = 'none');
            document.getElementById('page-' + page).style.display = 'block';
        }

        function showHome() {
            showPage('home');
            document.querySelector('.nav-item[data-page="home"]').classList.add('active');
            loadHomeData();
        }

        function loadPageData(page) {
            switch (page) {
                case 'home': loadHomeData(); break;
                case 'players': loadPlayers(); break;
                case 'competitions': loadCompetitions(); break;
                case 'ranking-manage': loadRankingManage(); break;
                case 'champions': loadChampionsPage(); break;
            }
        }

        // é¦–é¡µæ•°æ®
        async function loadHomeData() {
            try {
                const [annRes, playersRes, rankRes] = await Promise.all([
                    fetch(`${API_BASE}/announcements/published`),
                    fetch(`${API_BASE}/players`),
                    fetch(`${API_BASE}/players/ranking`)
                ]);
                const announcements = await annRes.json();
                const players = await playersRes.json();
                const ranking = await rankRes.json();

                const annHtml = announcements.length ? announcements.map(a => `
                    <div class="announcement-item" onclick="showAnnouncementDetail(${a.id})">
                        <div class="announcement-title">${a.title}</div>
                        <div>${a.content.substring(0, 100)}${a.content.length > 100 ? '...' : ''}</div>
                        <div class="announcement-date">${new Date(a.createdAt).toLocaleDateString()}</div>
                    </div>
                `).join('') : '<div class="empty-state">æš‚æ— å…¬å‘Š</div>';
                document.getElementById('announcements-list').innerHTML = annHtml;

                // è·å–å½“å‰å¹´ä»½çš„æ’åæ•°æ®ï¼ŒæŒ‰é¡¹ç›®åˆ†ç»„æ˜¾ç¤ºæ¯é¡¹çš„å‰3å
                const currentYear = new Date().getFullYear();
                let rankHtml = '';

                try {
                    const rankRes2 = await fetch(`${API_BASE}/rankings/year/${currentYear}`);
                    const rankings = await rankRes2.json();

                    if (rankings.length > 0) {
                        // æŒ‰é¡¹ç›®åˆ†ç»„
                        const grouped = {};
                        rankings.forEach(r => {
                            const cat = r.category || 'å…¶ä»–';
                            if (!grouped[cat]) grouped[cat] = [];
                            grouped[cat].push(r);
                        });

                        // æŒ‰é¡¹ç›®æ˜¾ç¤º
                        const categories = ['ç”·å•', 'å¥³å•', 'ç”·åŒ', 'å¥³åŒ', 'æ··åŒ', 'ç”·å›¢', 'å¥³å›¢'];
                        categories.forEach(cat => {
                            if (grouped[cat] && grouped[cat].length > 0) {
                                const top3 = grouped[cat].slice(0, 3).sort((a, b) => (a.ranking || 999) - (b.ranking || 999));
                                rankHtml += `
                                    <div style="margin-bottom: 20px;">
                                        <h4 style="margin-bottom: 10px; color: #1a73e8;">${cat} TOP 3</h4>
                                        <table class="ranking-table">
                                            <thead>
                                                <tr>
                                                    <th>æ’å</th>
                                                    <th>å§“å</th>
                                                    <th>å›½å®¶</th>
                                                    <th>ç§¯åˆ†</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${top3.map((p, i) => `
                                                    <tr class="rank-${i + 1}">
                                                        <td><span class="rank-num">${p.ranking || i + 1}</span></td>
                                                        <td>${p.playerName}</td>
                                                        <td>${p.country || '-'}</td>
                                                        <td class="points">${p.points}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                `;
                            }
                        });
                    } else {
                        rankHtml = '<div class="empty-state">æš‚æ— æ’åæ•°æ®</div>';
                    }
                } catch (e) {
                    console.error(e);
                    rankHtml = '<div class="empty-state">æš‚æ— æ’åæ•°æ®</div>';
                }

                document.getElementById('home-ranking').innerHTML = rankHtml;
            } catch (e) {
                console.error(e);
            }
        }

        // å…¬å‘Šè¯¦æƒ…
        async function showAnnouncementDetail(id) {
            currentAnnouncementId = id;
            try {
                const res = await fetch(`${API_BASE}/announcements/${id}`);
                const ann = await res.json();
                document.getElementById('ann-title').textContent = ann.title;
                document.getElementById('ann-type').textContent = ann.type === 'news' ? 'æ–°é—»' : ann.type === 'notice' ? 'é€šçŸ¥' : 'ç³»ç»Ÿ';
                document.getElementById('ann-date').textContent = new Date(ann.createdAt).toLocaleString();
                document.getElementById('ann-content').textContent = ann.content;
                showPage('announcement');
            } catch (e) {
                console.error(e);
            }
        }

        // ========== è¿åŠ¨å‘˜ç®¡ç† ==========
        async function loadPlayers() {
            try {
                const res = await fetch(`${API_BASE}/players`);
                allPlayers = await res.json();
                renderPlayersList(allPlayers);
            } catch (e) {
                console.error(e);
            }
        }

        function renderPlayersList(players) {
            const html = players.map(p => `
                <div class="player-card" onclick="showPlayerDetail(${p.id})">
                    <div class="player-avatar">${p.name.charAt(0)}</div>
                    <div class="player-name">${p.name}</div>
                    <div class="player-country">${p.country || '-'}</div>
                </div>
            `).join('');
            document.getElementById('players-grid').innerHTML = html || '<div class="empty-state">æš‚æ— è¿åŠ¨å‘˜</div>';
        }

        async function showPlayerDetail(id) {
            currentPlayerId = id;
            try {
                const res = await fetch(`${API_BASE}/players/${id}`);
                const p = await res.json();

                document.getElementById('detail-avatar').textContent = p.name.charAt(0);
                document.getElementById('detail-name').textContent = p.name;
                document.getElementById('detail-country').textContent = p.country || '-';
                document.getElementById('detail-intro').textContent = p.introduction || 'æš‚æ— ç®€ä»‹';
                document.getElementById('detail-age').textContent = p.age || '-';
                document.getElementById('detail-gender').textContent = p.gender || '-';
                document.getElementById('detail-points').textContent = p.rankingPoints || 0;

                const rankRes = await fetch(`${API_BASE}/players/ranking`);
                const ranking = await rankRes.json();
                const rank = ranking.findIndex(r => r.id === id) + 1;
                document.getElementById('detail-rank').textContent = rank || '-';

                document.getElementById('players-list-view').style.display = 'none';
                document.getElementById('player-detail-view').style.display = 'block';
            } catch (e) {
                console.error(e);
            }
        }

        function showPlayersList() {
            document.getElementById('players-list-view').style.display = 'block';
            document.getElementById('player-detail-view').style.display = 'none';
            currentPlayerId = null;
        }

        function showPlayerModal(id = null) {
            document.getElementById('player-modal').classList.add('show');
            document.getElementById('player-modal-title').textContent = id ? 'ç¼–è¾‘è¿åŠ¨å‘˜' : 'æ·»åŠ è¿åŠ¨å‘˜';
            document.getElementById('player-form').reset();
            document.getElementById('player-id').value = id || '';
            if (id) {
                fetch(`${API_BASE}/players/${id}`).then(r => r.json()).then(p => {
                    document.getElementById('player-name').value = p.name;
                    document.getElementById('player-country').value = p.country || '';
                    document.getElementById('player-age-input').value = p.age || '';
                    document.getElementById('player-gender').value = p.gender || 'ç”·';
                    document.getElementById('player-points').value = p.rankingPoints || 0;
                    document.getElementById('player-intro').value = p.introduction || '';
                });
            }
        }

        document.getElementById('player-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('player-id').value;
            const player = {
                name: document.getElementById('player-name').value,
                country: document.getElementById('player-country').value,
                age: parseInt(document.getElementById('player-age-input').value) || null,
                gender: document.getElementById('player-gender').value,
                rankingPoints: parseInt(document.getElementById('player-points').value) || 0,
                introduction: document.getElementById('player-intro').value
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_BASE}/players/${id}` : `${API_BASE}/players`;

            await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(player)
            });

            closeModal('player-modal');
            loadPlayers();
            if (currentPlayerId && id == currentPlayerId) {
                showPlayerDetail(currentPlayerId);
            }
        });

        async function editPlayer(id) { showPlayerModal(id); }

        async function deletePlayer(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªè¿åŠ¨å‘˜å—ï¼Ÿ')) {
                await fetch(`${API_BASE}/players/${id}`, { method: 'DELETE' });
                showPlayersList();
                loadPlayers();
            }
        }

        async function searchPlayers(keyword) {
            if (!keyword) { loadPlayers(); return; }
            const res = await fetch(`${API_BASE}/players/search?keyword=${keyword}`);
            const players = await res.json();
            renderPlayersList(players);
        }

        // ========== èµ›äº‹ç®¡ç† ==========
        let allCompetitions = [];

        async function loadCompetitions() {
            console.log('Loading competitions...');
            try {
                const res = await fetch(`${API_BASE}/competitions`);
                console.log('Response status:', res.status);
                if (!res.ok) {
                    const error = await res.text();
                    console.error('Error loading competitions:', error);
                    return;
                }
                allCompetitions = await res.json();
                console.log('Competitions loaded:', allCompetitions);

                // æå–å¹´ä»½åˆ—è¡¨
                const years = [...new Set(allCompetitions.map(c => c.competitionYear).filter(y => y))].sort((a, b) => a - b);
                const yearOptions = years.map(y => `<option value="${y}">${y}å¹´</option>`).join('');
                document.getElementById('competition-year-select').innerHTML = '<option value="">å…¨éƒ¨å¹´ä»½</option>' + yearOptions;

                filterCompetitions();
            } catch (e) {
                console.error('Error loading competitions:', e);
            }
        }

        function filterCompetitions() {
            const selectedYear = document.getElementById('competition-year-select').value;
            let filtered = allCompetitions;

            if (selectedYear) {
                filtered = allCompetitions.filter(c => c.competitionYear == selectedYear);
            }

            // æŒ‰å¹´ä»½é™åºæ’åºï¼ˆä»é«˜åˆ°ä½ï¼‰
            filtered.sort((a, b) => (b.competitionYear || 0) - (a.competitionYear || 0));

            // æŒ‰å¹´ä»½åˆ†ç»„æ˜¾ç¤º
            const grouped = {};
            filtered.forEach(c => {
                const year = c.competitionYear || 'æœªçŸ¥å¹´ä»½';
                if (!grouped[year]) grouped[year] = [];
                grouped[year].push(c);
            });

            let html = '';
            Object.keys(grouped).sort((a, b) => b - a).forEach(year => {
                html += `<h4 style="margin: 20px 0 10px; color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 5px;">${year}å¹´</h4>`;
                grouped[year].forEach(c => {
                    html += `
                        <div class="competition-card" onclick="showCompetitionDetail(${c.id})">
                            <div class="competition-info">
                                <h4>${c.name}</h4>
                                <p>ğŸ“ ${c.location || '-'} | ğŸ“… ${c.startDate && c.endDate ? new Date(c.startDate).toLocaleDateString() + ' - ' + new Date(c.endDate).toLocaleDateString() : c.startDate ? new Date(c.startDate).toLocaleDateString() : '-'}</p>
                            </div>
                            <div>
                                <button class="btn btn-warning" onclick="event.stopPropagation(); editCompetition(${c.id})">ç¼–è¾‘</button>
                                <button class="btn btn-danger" onclick="event.stopPropagation(); deleteCompetition(${c.id})">åˆ é™¤</button>
                            </div>
                        </div>
                    `;
                });
            });

            document.getElementById('competitions-list').innerHTML = html || '<div class="empty-state">æš‚æ— èµ›äº‹</div>';
        }

        async function showCompetitionDetail(id) {
            currentCompetitionId = id;
            try {
                const [compRes, matchRes] = await Promise.all([
                    fetch(`${API_BASE}/competitions/${id}`),
                    fetch(`${API_BASE}/matches/competition/${id}`)
                ]);
                const comp = await compRes.json();
                const matches = await matchRes.json();

                const playersRes = await fetch(`${API_BASE}/players`);
                const players = await playersRes.json();
                const playerMap = {};
                const playerCountryMap = {};
                const countryFlagMap = {
                    'ä¸­å›½': 'ğŸ‡¨ğŸ‡³', 'æ—¥æœ¬': 'ğŸ‡¯ğŸ‡µ', 'éŸ©å›½': 'ğŸ‡°ğŸ‡·', 'å¾·å›½': 'ğŸ‡©ğŸ‡ª',
                    'ç‘å…¸': 'ğŸ‡¸ğŸ‡ª', 'ç¾å›½': 'ğŸ‡ºğŸ‡¸', 'æ³•å›½': 'ğŸ‡«ğŸ‡·', 'è‹±å›½': 'ğŸ‡¬ğŸ‡§',
                    'å·´è¥¿': 'ğŸ‡§ğŸ‡·', 'å°åº¦': 'ğŸ‡®ğŸ‡³'
                };
                function getFlag(country) {
                    return countryFlagMap[country] || 'ğŸŒ';
                }
                players.forEach(p => {
                    playerMap[p.id] = p.name;
                    playerCountryMap[p.id] = p.country || '';
                });

                const dateRange = comp.startDate && comp.endDate
                    ? `${new Date(comp.startDate).toLocaleDateString()} - ${new Date(comp.endDate).toLocaleDateString()}`
                    : comp.startDate
                        ? new Date(comp.startDate).toLocaleDateString()
                        : '';

                const yearStr = comp.competitionYear ? `${comp.competitionYear}å¹´ ` : '';
                document.getElementById('competition-title').textContent = yearStr + comp.name + (dateRange ? ` (${dateRange})` : '');

                const statusMap = { scheduled: 'å·²å®‰æ’', ongoing: 'è¿›è¡Œä¸­', completed: 'å·²å®Œæˆ', cancelled: 'å·²å–æ¶ˆ' };
                const roundMap = { 1: '1/4å†³èµ›', 2: 'åŠå†³èµ›', 3: 'å†³èµ›' };

                function getScoreDisplay(m, p1Total, p2Total, scores) {
                    if (m.category === 'ç”·å›¢' || m.category === 'å¥³å›¢') {
                        return `<span style="font-weight:bold; font-size:16px;">${p1Total}-${p2Total}</span>`;
                    }
                    return scores.length > 0
                        ? scores.map(s => `<span class="game-score">${s.p1}-${s.p2}</span>`).join('')
                        : `${m.player1Total || 0}-${m.player2Total || 0}`;
                }

                function getMatchTableHtml(matches, isTeam) {
                    const statusMap = { scheduled: 'å·²å®‰æ’', ongoing: 'è¿›è¡Œä¸­', completed: 'å·²å®Œæˆ', cancelled: 'å·²å–æ¶ˆ' };
                    return `
                        <table class="score-table">
                            <thead>
                                <tr>
                                    <th>è½®æ¬¡</th>
                                    <th>é€‰æ‰‹1</th>
                                    <th>å›½å®¶</th>
                                    <th>${isTeam ? 'å¤§æ¯”åˆ†' : 'æ¯”åˆ†'}</th>
                                    <th>é€‰æ‰‹2</th>
                                    <th>å›½å®¶</th>
                                    <th>åœºé¦†</th>
                                    <th>æ—¥æœŸ</th>
                                    <th>çŠ¶æ€</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${matches.map(m => {
                        let scores = [];
                        let p1Total = 0, p2Total = 0;
                        try {
                            if (m.scores) {
                                scores = JSON.parse(m.scores);
                                scores.forEach(s => {
                                    if (s.p1 > s.p2) p1Total++;
                                    else if (s.p2 > s.p1) p2Total++;
                                });
                            }
                        } catch (e) { }

                        const p1Name = m.player1Name || playerMap[m.player1Id] || '-';
                        const p2Name = m.player2Name || playerMap[m.player2Id] || '-';
                        const p1Country = m.player1Country || playerCountryMap[m.player1Id] || '-';
                        const p2Country = m.player2Country || playerCountryMap[m.player2Id] || '-';

                        return `
                                        <tr>
                                            <td>${m.roundNumber || '-'}</td>
                                            <td class="${p1Total > p2Total ? 'winner' : ''}">${p1Name}</td>
                                            <td>${p1Country}</td>
                                            <td>${getScoreDisplay(m, p1Total, p2Total, scores)}</td>
                                            <td class="${p2Total > p1Total ? 'winner' : ''}">${p2Name}</td>
                                            <td>${p2Country}</td>
                                            <td>${m.venue || '-'}</td>
                                            <td>${formatDateTime(m.matchDate)}</td>
                                            <td>${statusMap[m.status] || m.status}</td>
                                            <td>
                                                <button class="btn btn-warning" onclick="editMatch(${m.id})">ç¼–è¾‘</button>
                                                <button class="btn btn-danger" onclick="deleteMatch(${m.id})">åˆ é™¤</button>
                                            </td>
                                        </tr>
                                    `;
                    }).join('')}
                            </tbody>
                        </table>
                    `;
                }

                let html = '';
                if (matches.length === 0) {
                    html = '<div class="empty-state">æš‚æ— æ¯”èµ›è®°å½•</div>';
                } else {
                    // æŒ‰é¡¹ç›®åˆ†ç»„
                    const categories = ['ç”·å•', 'å¥³å•', 'ç”·åŒ', 'å¥³åŒ', 'æ··åŒ', 'ç”·å›¢', 'å¥³å›¢'];
                    const grouped = {};
                    matches.forEach(m => {
                        const cat = m.category || 'å…¶ä»–';
                        if (!grouped[cat]) grouped[cat] = [];
                        grouped[cat].push(m);
                    });

                    // æ’åºå‡½æ•°
                    function sortByRound(matches) {
                        const order = {
                            'å°ç»„èµ›': 1, '1/8': 2, '1/4': 3, 'å››åˆ†ä¹‹ä¸€': 3,
                            'åŠå†³': 4, 'å†³èµ›': 5, 'é“œç‰Œ': 6, 'ä¸‰å››å': 6
                        };
                        const groupNumbers = Array.from({ length: 20 }, (_, i) => i + 1);
                        return matches.sort((a, b) => {
                            const ra = a.roundNumber || '';
                            const rb = b.roundNumber || '';
                            // å…ˆæŒ‰è½®æ¬¡æ’åº
                            let orderA = 999, orderB = 999;
                            for (const [key, val] of Object.entries(order)) {
                                if (ra.includes(key)) orderA = val;
                                if (rb.includes(key)) orderB = val;
                            }
                            // å°ç»„èµ›æŒ‰ç»„å·æ’åº
                            if (orderA === 1) {
                                for (const num of groupNumbers) {
                                    if (ra.includes(num + 'ç»„') || ra.includes('ç»„' + num)) {
                                        orderA = 1 + num * 0.01;
                                        break;
                                    }
                                }
                            }
                            if (orderB === 1) {
                                for (const num of groupNumbers) {
                                    if (rb.includes(num + 'ç»„') || rb.includes('ç»„' + num)) {
                                        orderB = 1 + num * 0.01;
                                        break;
                                    }
                                }
                            }
                            if (orderA !== orderB) return orderA - orderB;
                            // åŒè½®æ¬¡æŒ‰æ—¥æœŸæ’åº
                            return new Date(a.matchDate || 0) - new Date(b.matchDate || 0);
                        });
                    }

                    categories.forEach(cat => {
                        if (grouped[cat] && grouped[cat].length > 0) {
                            const isTeam = (cat === 'ç”·å›¢' || cat === 'å¥³å›¢');
                            const sortedMatches = sortByRound([...grouped[cat]]);

                            // æ£€æŸ¥æ˜¯å¦æœ‰å°ç»„èµ›ï¼ˆåŒ…å«1-20æ•°å­—çš„ï¼‰
                            const groupNumbers = Array.from({ length: 20 }, (_, i) => String(i + 1));
                            const hasGroupStage = sortedMatches.some(m => {
                                const round = m.roundNumber || '';
                                return groupNumbers.some(n => round.includes(n + 'ç»„') || round.includes('ç»„' + n));
                            });

                            html += `
                                <div style="margin-bottom: 30px;">
                                    <h4 style="margin-bottom: 10px; color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 5px;">${cat}</h4>`;

                            if (hasGroupStage) {
                                // æŒ‰å°ç»„åˆ†ç»„æ˜¾ç¤º
                                const groups = {};
                                sortedMatches.forEach(m => {
                                    const round = m.roundNumber || '';
                                    let group = 'å…¶ä»–';
                                    for (const num of groupNumbers) {
                                        if (round.includes(num + 'ç»„') || round.includes('ç»„' + num)) {
                                            group = num;
                                            break;
                                        }
                                    }
                                    if (!groups[group]) groups[group] = [];
                                    groups[group].push(m);
                                });

                                // æŒ‰å°ç»„é¡ºåºæ˜¾ç¤º
                                groupNumbers.forEach(n => {
                                    if (groups[n]) {
                                        html += `<h5 style="margin: 15px 0 10px; color: #666;">ğŸ… ç¬¬${n}ç»„</h5>`;
                                        html += getMatchTableHtml(groups[n], isTeam);
                                    }
                                });
                                // å…¶ä»–
                                if (groups['å…¶ä»–']) {
                                    html += `<h5 style="margin: 15px 0 10px; color: #666;">å…¶ä»–</h5>`;
                                    html += getMatchTableHtml(groups['å…¶ä»–'], isTeam);
                                }
                            } else {
                                html += getMatchTableHtml(sortedMatches, isTeam);
                            }

                            html += `</div>`;
                        }
                    });

                    // å…¶ä»–é¡¹ç›®
                    if (grouped['å…¶ä»–'] && grouped['å…¶ä»–'].length > 0) {
                        const sortedMatches = sortByRound([...grouped['å…¶ä»–']]);
                        html += `
                            <div style="margin-bottom: 30px;">
                                <h4 style="margin-bottom: 10px; color: #666;">å…¶ä»–</h4>
                                ${getMatchTableHtml(sortedMatches, false)}
                            </div>
                        `;
                    }
                }

                document.getElementById('competition-matches').innerHTML = html;
                document.getElementById('competitions-list-view').style.display = 'none';
                document.getElementById('competition-detail-view').style.display = 'block';
            } catch (e) {
                console.error(e);
            }
        }

        function showCompetitionsList() {
            document.getElementById('competitions-list-view').style.display = 'block';
            document.getElementById('competition-detail-view').style.display = 'none';
            currentCompetitionId = null;
        }

        function showCompetitionModal(id = null) {
            console.log('Opening competition modal, id:', id);
            document.getElementById('competition-modal').classList.add('show');
            document.getElementById('competition-modal-title').textContent = id ? 'ç¼–è¾‘èµ›äº‹' : 'æ·»åŠ èµ›äº‹';
            document.getElementById('competition-form').reset();
            document.getElementById('competition-id').value = id || '';
            document.getElementById('competition-year').value = new Date().getFullYear();
            console.log('Modal should be visible now');
            if (id) {
                fetch(`${API_BASE}/competitions/${id}`).then(r => r.json()).then(c => {
                    document.getElementById('competition-name').value = c.name;
                    document.getElementById('competition-year').value = c.competitionYear || new Date().getFullYear();
                    document.getElementById('competition-location').value = c.location || '';
                    document.getElementById('competition-start').value = c.startDate ? c.startDate.slice(0, 10) : '';
                    document.getElementById('competition-end').value = c.endDate ? c.endDate.slice(0, 10) : '';
                    document.getElementById('competition-desc').value = c.description || '';
                }).catch(e => console.error('Error loading competition:', e));
            }
        }

        document.getElementById('competition-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('competition-id').value;
            const comp = {
                name: document.getElementById('competition-name').value,
                competitionYear: parseInt(document.getElementById('competition-year').value) || new Date().getFullYear(),
                location: document.getElementById('competition-location').value,
                startDate: document.getElementById('competition-start').value ? document.getElementById('competition-start').value + 'T00:00:00' : null,
                endDate: document.getElementById('competition-end').value ? document.getElementById('competition-end').value + 'T00:00:00' : null,
                description: document.getElementById('competition-desc').value,
                isActive: true
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_BASE}/competitions/${id}` : `${API_BASE}/competitions`;

            console.log('Saving competition:', comp);

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(comp)
                });

                if (!response.ok) {
                    const error = await response.text();
                    alert('ä¿å­˜å¤±è´¥: ' + error);
                    return;
                }

                const result = await response.json();
                console.log('Competition saved:', result);
            } catch (error) {
                console.error('Error:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
                return;
            }

            closeModal('competition-modal');
            loadCompetitions();
        });

        async function editCompetition(id) { showCompetitionModal(id); }

        async function deleteCompetition(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªèµ›äº‹å—ï¼Ÿè¯¥èµ›äº‹ä¸‹çš„æ‰€æœ‰æ¯”èµ›è®°å½•ä¹Ÿå°†è¢«åˆ é™¤ï¼')) {
                try {
                    const response = await fetch(`${API_BASE}/competitions/${id}`, { method: 'DELETE' });
                    if (!response.ok) {
                        const error = await response.text();
                        alert('åˆ é™¤å¤±è´¥: ' + error);
                        return;
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('åˆ é™¤å¤±è´¥: ' + error.message);
                    return;
                }
                loadCompetitions();
            }
        }

        // ========== æ¯”èµ›ç®¡ç† ==========
        function renderScoreInputs() {
            const games = parseInt(document.getElementById('match-games').value);
            const container = document.getElementById('score-inputs-container');
            let html = '';
            for (let i = 1; i <= games; i++) {
                html += `
                    <div class="score-input-row">
                        <span>ç¬¬${i}å±€:</span>
                        <input type="number" class="score-p1" placeholder="é€‰æ‰‹1" min="0" max="20">
                        <span>:</span>
                        <input type="number" class="score-p2" placeholder="é€‰æ‰‹2" min="0" max="20">
                    </div>
                `;
            }
            container.innerHTML = html;
        }

        let playerNameMap = {}; // åå­—åˆ°IDçš„æ˜ å°„

        async function showMatchModal(id = null) {
            // åŠ è½½é€‰æ‰‹åˆ—è¡¨åˆ°datalist
            const playerRes = await fetch(`${API_BASE}/players`);
            const players = await playerRes.json();

            // æ„å»ºåå­—æ˜ å°„
            playerNameMap = {};
            players.forEach(p => {
                playerNameMap[p.name] = p.id;
            });

            // å¡«å……datalist
            const options = players.map(p => `<option value="${p.name}">`).join('');
            document.getElementById('player-suggestions').innerHTML = options;

            renderScoreInputs();

            document.getElementById('match-modal').classList.add('show');
            document.getElementById('match-modal-title').textContent = id ? 'ç¼–è¾‘æ¯”èµ›' : 'æ·»åŠ æ¯”èµ›';
            document.getElementById('match-form').reset();
            document.getElementById('match-id').value = id || '';

            if (id) {
                fetch(`${API_BASE}/matches/${id}`).then(r => r.json()).then(m => {
                    // ä½¿ç”¨ä¿å­˜çš„é€‰æ‰‹ä¿¡æ¯ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»playersè¡¨æŸ¥æ‰¾
                    const p1Name = m.player1Name || players.find(p => p.id === m.player1Id)?.name || '';
                    const p2Name = m.player2Name || players.find(p => p.id === m.player2Id)?.name || '';
                    const p1Country = m.player1Country || players.find(p => p.id === m.player1Id)?.country || '';
                    const p2Country = m.player2Country || players.find(p => p.id === m.player2Id)?.country || '';

                    document.getElementById('match-player1').value = p1Name;
                    document.getElementById('match-player2').value = p2Name;
                    document.getElementById('match-player1-country').value = p1Country;
                    document.getElementById('match-player2-country').value = p2Country;
                    document.getElementById('match-venue').value = m.venue || '';
                    document.getElementById('match-status').value = m.status || 'scheduled';
                    document.getElementById('match-category').value = m.category || 'ç”·å•';
                    document.getElementById('match-round').value = m.roundNumber || '';
                    document.getElementById('match-remark').value = m.remark || '';
                    if (m.matchDate) {
                        document.getElementById('match-date').value = m.matchDate.slice(0, 16);
                    }

                    // åŠ è½½æ¯”åˆ†
                    if (m.scores) {
                        try {
                            const scores = JSON.parse(m.scores);
                            document.getElementById('match-games').value = scores.length;
                            renderScoreInputs();
                            const p1Inputs = document.querySelectorAll('.score-p1');
                            const p2Inputs = document.querySelectorAll('.score-p2');
                            scores.forEach((s, i) => {
                                if (p1Inputs[i]) p1Inputs[i].value = s.p1;
                                if (p2Inputs[i]) p2Inputs[i].value = s.p2;
                            });
                        } catch (e) { }
                    }
                });
            }
        }

        document.getElementById('match-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('match-id').value;

            // ç›´æ¥è¾“å…¥è¿åŠ¨å‘˜å§“åï¼Œä¸ä¸è¿åŠ¨å‘˜ç®¡ç†æŒ‚é’©
            const p1Name = document.getElementById('match-player1').value.trim();
            const p2Name = document.getElementById('match-player2').value.trim();

            if (!p1Name || !p2Name) {
                alert('è¯·è¾“å…¥é€‰æ‰‹å§“å');
                return;
            }

            if (p1Name === p2Name) {
                alert('ä¸èƒ½é€‰æ‹©åŒä¸€åé€‰æ‰‹');
                return;
            }

            // æŸ¥æ‰¾å·²æœ‰åä¸ºp1Nameå’Œp2Nameçš„è¿åŠ¨å‘˜IDï¼ˆç”¨äºå…³è”ï¼‰
            const player1Id = playerNameMap[p1Name] || null;
            const player2Id = playerNameMap[p2Name] || null;

            // æ”¶é›†æ¯”åˆ†
            const p1Inputs = document.querySelectorAll('.score-p1');
            const p2Inputs = document.querySelectorAll('.score-p2');
            const scores = [];
            let p1Total = 0, p2Total = 0;

            p1Inputs.forEach((input, i) => {
                const p1 = parseInt(input.value) || 0;
                const p2 = parseInt(p2Inputs[i].value) || 0;
                scores.push({ p1, p2 });
                if (p1 > p2) p1Total++;
                else if (p2 > p1) p2Total++;
            });

            const match = {
                competitionId: currentCompetitionId,
                player1Id: player1Id,
                player1Name: p1Name,
                player1Country: document.getElementById('match-player1-country').value || '',
                player2Id: player2Id,
                player2Name: p2Name,
                player2Country: document.getElementById('match-player2-country').value || '',
                scores: JSON.stringify(scores),
                player1Total: p1Total,
                player2Total: p2Total,
                venue: document.getElementById('match-venue').value,
                matchDate: document.getElementById('match-date').value || null,
                status: document.getElementById('match-status').value,
                roundNumber: document.getElementById('match-round').value || null,
                category: document.getElementById('match-category').value,
                remark: document.getElementById('match-remark').value
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_BASE}/matches/${id}` : `${API_BASE}/matches`;

            console.log('Saving match:', match);

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(match)
                });

                if (!response.ok) {
                    const error = await response.text();
                    alert('ä¿å­˜å¤±è´¥: ' + error);
                    return;
                }

                const result = await response.json();
                console.log('Match saved:', result);
            } catch (error) {
                console.error('Error:', error);
                alert('ä¿å­˜å¤±è´¥: ' + error.message);
                return;
            }

            closeModal('match-modal');
            if (currentCompetitionId) {
                showCompetitionDetail(currentCompetitionId);
            }
        });

        async function editMatch(id) { showMatchModal(id); }

        async function deleteMatch(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¯”èµ›è®°å½•å—ï¼Ÿ')) {
                await fetch(`${API_BASE}/matches/${id}`, { method: 'DELETE' });
                if (currentCompetitionId) {
                    showCompetitionDetail(currentCompetitionId);
                }
            }
        }

        // ========== æ’åç®¡ç† ==========
        let rankingPlayerMap = {};

        async function loadRankingManage() {
            try {
                const yearsRes = await fetch(`${API_BASE}/rankings/years`);
                const years = await yearsRes.json();

                const currentYear = new Date().getFullYear();
                const yearOptions = years.length ? years.map(y => `<option value="${y}">${y}å¹´</option>`).join('') : `<option value="${currentYear}">${currentYear}å¹´</option>`;
                document.getElementById('ranking-year-select').innerHTML = '<option value="">é€‰æ‹©å¹´ä»½</option>' + yearOptions;

                const firstYear = years.length ? years[years.length - 1] : currentYear;
                if (!document.getElementById('ranking-year-select').value) {
                    document.getElementById('ranking-year-select').value = firstYear;
                    await loadRankingsByFilter();
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function loadRankingsByFilter() {
            const year = document.getElementById('ranking-year-select').value;
            const category = document.getElementById('ranking-category-select').value;

            if (!year) {
                document.getElementById('ranking-by-year').innerHTML = '<div class="empty-state">è¯·é€‰æ‹©å¹´ä»½</div>';
                return;
            }

            try {
                let url = `${API_BASE}/rankings/year/${year}`;
                if (category) {
                    url = `${API_BASE}/rankings/year/${year}/category/${encodeURIComponent(category)}`;
                }

                const res = await fetch(url);
                const rankings = await res.json();

                rankingPlayerMap = {};
                rankings.forEach(r => {
                    rankingPlayerMap[r.playerName] = r.id;
                });

                // æŒ‰é¡¹ç›®åˆ†ç»„
                const grouped = {};
                rankings.forEach(r => {
                    const cat = r.category || 'å…¶ä»–';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push(r);
                });

                // å¯¹æ¯ä¸ªé¡¹ç›®å†…çš„æ’åè¿›è¡Œæ’åº
                Object.keys(grouped).forEach(cat => {
                    grouped[cat].sort((a, b) => (a.ranking || 999) - (b.ranking || 999));
                });

                const categories = ['ç”·å•', 'å¥³å•', 'ç”·åŒ', 'å¥³åŒ', 'æ··åŒ', 'ç”·å›¢', 'å¥³å›¢'];
                let html = '';

                categories.forEach(cat => {
                    if (grouped[cat] && grouped[cat].length > 0) {
                        html += `
                            <div style="margin-bottom: 30px;">
                                <h4 style="margin-bottom: 10px; color: #1a73e8;">${cat}</h4>
                                <table class="ranking-table">
                                    <thead>
                                        <tr>
                                            <th>æ’å</th>
                                            <th>è¿åŠ¨å‘˜</th>
                                            <th>å›½å®¶</th>
                                            <th>ç§¯åˆ†</th>
                                            <th>æ“ä½œ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${grouped[cat].map((r, i) => `
                                            <tr class="rank-${i + 1}">
                                                <td><span class="rank-num">${r.ranking || i + 1}</span></td>
                                                <td>${r.playerName}</td>
                                                <td>${r.country || '-'}</td>
                                                <td class="points">${r.points || 0}</td>
                                                <td>
                                                    <button class="btn btn-warning" onclick="editRanking(${r.id})">ç¼–è¾‘</button>
                                                    <button class="btn btn-danger" onclick="deleteRanking(${r.id})">åˆ é™¤</button>
                                                </td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        `;
                    }
                });

                document.getElementById('ranking-by-year').innerHTML = html || '<div class="empty-state">è¯¥å¹´ä»½æš‚æ— æ’åæ•°æ®</div>';
            } catch (e) {
                console.error(e);
            }
        }

        function showRankingModal(id = null) {
            const year = document.getElementById('ranking-year-select').value || new Date().getFullYear();
            const category = document.getElementById('ranking-category-select').value || 'ç”·å•';

            document.getElementById('ranking-modal').classList.add('show');
            document.getElementById('ranking-modal-title').textContent = id ? 'ç¼–è¾‘æ’å' : `æ·»åŠ æ’å`;
            document.getElementById('ranking-form').reset();
            document.getElementById('ranking-id').value = id || '';
            document.getElementById('ranking-year').value = year;
            document.getElementById('ranking-category').value = category;

            if (id) {
                fetch(`${API_BASE}/rankings/${id}`).then(r => r.json()).then(r => {
                    document.getElementById('ranking-year').value = r.rankingYear;
                    document.getElementById('ranking-category').value = r.category || 'ç”·å•';
                    document.getElementById('ranking-num').value = r.ranking;
                    document.getElementById('ranking-player-name').value = r.playerName || '';
                    document.getElementById('ranking-country').value = r.country || '';
                    document.getElementById('ranking-points').value = r.points || 0;
                });
            }
        }

        document.getElementById('ranking-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('ranking-id').value;
            const playerName = document.getElementById('ranking-player-name').value.trim();
            const country = document.getElementById('ranking-country').value.trim();
            const points = parseInt(document.getElementById('ranking-points').value) || 0;
            const ranking = parseInt(document.getElementById('ranking-num').value) || 1;
            const year = parseInt(document.getElementById('ranking-year').value) || new Date().getFullYear();
            const category = document.getElementById('ranking-category').value;

            if (!playerName) {
                alert('è¯·è¾“å…¥è¿åŠ¨å‘˜å§“å');
                return;
            }

            const rankingData = {
                playerName: playerName,
                country: country,
                points: points,
                ranking: ranking,
                rankingYear: year,
                category: category
            };

            let method, url;
            if (id) {
                method = 'PUT';
                url = `${API_BASE}/rankings/${id}`;
            } else {
                method = 'POST';
                url = `${API_BASE}/rankings`;
            }

            await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rankingData)
            });

            closeModal('ranking-modal');
            loadRankingsByFilter();
        });

        async function editRanking(id) { showRankingModal(id); }

        async function deleteRanking(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ’åè®°å½•å—ï¼Ÿ')) {
                await fetch(`${API_BASE}/rankings/${id}`, { method: 'DELETE' });
                loadRankingsByFilter();
            }
        }

        // ========== èµ›äº‹å† å†› ==========
        let allCompetitionsForChampions = [];

        async function loadChampionsPage() {
            try {
                const res = await fetch(`${API_BASE}/competitions`);
                allCompetitionsForChampions = await res.json();

                // æŒ‰å¹´ä»½åˆ†ç»„æ˜¾ç¤º
                allCompetitionsForChampions.sort((a, b) => (b.competitionYear || 0) - (a.competitionYear || 0));

                const grouped = {};
                allCompetitionsForChampions.forEach(c => {
                    const year = c.competitionYear || 'æœªçŸ¥å¹´ä»½';
                    if (!grouped[year]) grouped[year] = [];
                    grouped[year].push(c);
                });

                let html = '';
                Object.keys(grouped).sort((a, b) => b - a).forEach(year => {
                    html += `<h4 style="margin: 20px 0 10px; color: #1a73e8; border-bottom: 2px solid #1a73e8; padding-bottom: 5px;">${year}å¹´</h4>`;
                    grouped[year].forEach(c => {
                        const dateRange = c.startDate && c.endDate
                            ? `${new Date(c.startDate).toLocaleDateString()} - ${new Date(c.endDate).toLocaleDateString()}`
                            : c.startDate
                                ? `${new Date(c.startDate).toLocaleDateString()}`
                                : '-';
                        html += `
                            <div class="competition-card" onclick="showCompetitionChampions(${c.id})">
                                <div class="competition-info">
                                    <h4>${c.name}</h4>
                                    <p>ğŸ“… ${dateRange} | ğŸ“ ${c.location || '-'}</p>
                                </div>
                            </div>
                        `;
                    });
                });

                document.getElementById('champions-competitions-list').innerHTML = html || '<div class="empty-state">æš‚æ— èµ›äº‹</div>';
            } catch (e) {
                console.error(e);
            }
        }

        function showChampionsList() {
            showPage('champions');
        }

        async function showCompetitionChampions(competitionId) {
            try {
                const compRes = await fetch(`${API_BASE}/competitions/${competitionId}`);
                const comp = await compRes.json();

                const matchRes = await fetch(`${API_BASE}/matches/competition/${competitionId}`);
                const matches = await matchRes.json();

                const yearStr = comp.competitionYear ? `${comp.competitionYear}å¹´ ` : '';
                document.getElementById('champions-competition-title').textContent = yearStr + comp.name;

                const dateRange = comp.startDate && comp.endDate
                    ? `${new Date(comp.startDate).toLocaleDateString()} - ${new Date(comp.endDate).toLocaleDateString()}`
                    : comp.startDate
                        ? `${new Date(comp.startDate).toLocaleDateString()}`
                        : '';

                // æŒ‰é¡¹ç›®åˆ†ç»„
                const categories = ['ç”·å•', 'å¥³å•', 'ç”·åŒ', 'å¥³åŒ', 'æ··åŒ', 'ç”·å›¢', 'å¥³å›¢'];
                const grouped = {};
                matches.forEach(m => {
                    const cat = m.category || 'å…¶ä»–';
                    if (!grouped[cat]) grouped[cat] = [];
                    grouped[cat].push(m);
                });

                let html = `<p style="color:#666; margin-bottom:20px;">ğŸ“… ${dateRange} | ğŸ“ ${comp.location || '-'}</p>`;

                // åªæ˜¾ç¤ºå† äºšå­£å†›
                categories.forEach(cat => {
                    if (grouped[cat] && grouped[cat].length > 0) {
                        const results = getMedalWinners(grouped[cat], cat);
                        if (results) {
                            html += `
                                <div style="margin-bottom: 30px; padding: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 10px; color: white;">
                                    <h3 style="margin-bottom: 15px; text-align:center; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px;">${cat}</h3>
                                    <div style="display:flex; justify-content:center; align-items:flex-end; gap: 30px; text-align:center;">
                                        <div style="order: 2;">
                                            <div style="font-size: 40px;">ğŸ¥‡</div>
                                            <div style="font-size: 18px; font-weight: bold;">${results.champion || '-'}</div>
                                            <div style="font-size: 12px; opacity: 0.8;">å† å†›</div>
                                        </div>
                                        <div style="order: 1;">
                                            <div style="font-size: 30px;">ğŸ¥ˆ</div>
                                            <div style="font-size: 16px; font-weight: bold;">${results.runnerUp || '-'}</div>
                                            <div style="font-size: 12px; opacity: 0.8;">äºšå†›</div>
                                        </div>
                                    <div style="order: 3;">
                                                <div style="font-size: 30px;">ğŸ¥‰</div>
                                                <div style="font-size: 16px; font-weight: bold;">${Array.isArray(results.thirdPlaces) ? results.thirdPlaces.join('ã€') : results.thirdPlace || '-'}</div>
                                                <div style="font-size: 12px; opacity: 0.8;">${Array.isArray(results.thirdPlaces) && results.thirdPlaces.length > 1 ? 'å­£å†›(å¹¶åˆ—)' : 'å­£å†›'}</div>
                                                <div style="font-size: 10px; color: yellow; margin-top: 5px;">[DEBUG] åŠå†³èµ›: ${results._debug?.semiFinalsCount || 0}</div>
                                            </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                });

                if (html === `<p style="color:#666; margin-bottom:20px;">ğŸ“… ${dateRange} | ğŸ“ ${comp.location || '-'}</p>`) {
                    html += '<div class="empty-state">æš‚æ— å† äºšå­£å†›ä¿¡æ¯ï¼ˆéœ€å®Œæˆå†³èµ›è½®æ¬¡ï¼‰</div>';
                }

                // å…¶ä»–é¡¹ç›®
                Object.keys(grouped).forEach(cat => {
                    if (!categories.includes(cat)) {
                        const results = getMedalWinners(grouped[cat], cat);
                        if (results) {
                            html += `
                                <div style="margin-bottom: 30px; padding: 20px; background: #f5f5f5; border-radius: 10px;">
                                    <h3 style="margin-bottom: 15px; text-align:center;">${cat}</h3>
                                    <div style="display:flex; justify-content:center; align-items:flex-end; gap: 30px; text-align:center;">
                                        <div>
                                            <div style="font-size: 40px;">ğŸ¥‡</div>
                                            <div style="font-size: 18px; font-weight: bold;">${results.champion || '-'}</div>
                                            <div style="font-size: 12px; color: #666;">å† å†›</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 30px;">ğŸ¥ˆ</div>
                                            <div style="font-size: 16px; font-weight: bold;">${results.runnerUp || '-'}</div>
                                            <div style="font-size: 12px; color: #666;">äºšå†›</div>
                                        </div>
                                        <div>
                                            <div style="font-size: 30px;">ğŸ¥‰</div>
                                            <div style="font-size: 16px; font-weight: bold;">${Array.isArray(results.thirdPlaces) ? results.thirdPlaces.join('ã€') : results.thirdPlace || '-'}</div>
                                            <div style="font-size: 12px; color: #666;">${Array.isArray(results.thirdPlaces) && results.thirdPlaces.length > 1 ? 'å­£å†›(å¹¶åˆ—)' : 'å­£å†›'}</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }
                });

                if (html === `<p style="color:#666; margin-bottom:20px;">ğŸ“… ${dateRange} | ğŸ“ ${comp.location || '-'}</p>`) {
                    html += '<div class="empty-state">æš‚æ— æ¯”èµ›è®°å½•</div>';
                }

                document.getElementById('champions-detail-content').innerHTML = html;

                document.getElementById('page-champions').style.display = 'none';
                document.getElementById('page-champions-detail').style.display = 'block';
            } catch (e) {
                console.error(e);
            }
        }

        function getMedalWinners(matches, category) {
            console.log('=== getMedalWinners called ===');
            console.log('All matches:', matches.map(m => ({ id: m.id, round: m.roundNumber, status: m.status, p1: m.player1Name })));

            // åªå¤„ç†å·²å®Œæˆæ¯”èµ›ï¼ˆå…¼å®¹å¤šç§çŠ¶æ€å€¼ï¼‰
            const completedMatches = matches.filter(m => {
                const status = (m.status || '').toLowerCase();
                return status === 'completed' || status === 'finished' || status === 'å·²å®Œæˆ' || status === 'å·²ç»“æŸ';
            });

            console.log('All matches:', matches.map(m => ({ id: m.id, round: m.roundNumber, status: m.status, p1: m.player1Name })));
            console.log('Completed matches:', completedMatches.map(m => ({ id: m.id, round: m.roundNumber, p1: m.player1Name })));

            if (completedMatches.length === 0) return null;

            // æ‰¾å†³èµ›ï¼ˆå¿…é¡»åŒ…å«"å†³èµ›"æˆ–"Final"ï¼Œä¸”ä¸æ˜¯1/Xxå†³èµ›æ ¼å¼ï¼‰
            const allFinals = completedMatches.filter(m => {
                const r = m.roundNumber || '';
                const isFinal = (r.includes('å†³èµ›') || r.toLowerCase().includes('final'))
                    && !/1\/\d+å†³èµ›/.test(r) && !r.includes('åŠ');
                return isFinal;
            });

            // æŒ‰æ—¥æœŸæ’åºï¼Œå–æœ€æ™šçš„å†³èµ›
            allFinals.sort((a, b) => new Date(b.matchDate || 0) - new Date(a.matchDate || 0));

            const finalMatch = allFinals.length > 0 ? allFinals[0] : null;

            console.log('Final match:', finalMatch ? { id: finalMatch.id, p1: finalMatch.player1Name, p2: finalMatch.player2Name } : 'none');

            // æ²¡æœ‰å†³èµ›ï¼Œä¸æ˜¾ç¤ºå† äºšå­£å†›
            if (!finalMatch) {
                console.log('No final match, returning null');
                return null;
            }

            let champion = null;
            let runnerUp = null;
            let thirdPlace = null;
            let thirdPlaces = [];

            // è®¡ç®—æ€»åˆ†
            let p1Total = finalMatch.player1Total || 0;
            let p2Total = finalMatch.player2Total || 0;

            // ä»scoresè®¡ç®—
            if ((p1Total === 0 && p2Total === 0) && finalMatch.scores) {
                try {
                    const scores = JSON.parse(finalMatch.scores);
                    scores.forEach(s => {
                        if (s.p1 > s.p2) p1Total++;
                        else if (s.p2 > s.p1) p2Total++;
                    });
                } catch (e) { }
            }

            console.log('Final scores:', p1Total, p2Total);

            if (p1Total > p2Total) {
                champion = finalMatch.player1Name;
                runnerUp = finalMatch.player2Name;
            } else if (p2Total > p1Total) {
                champion = finalMatch.player2Name;
                runnerUp = finalMatch.player1Name;
            } else {
                console.log('Final match is a tie, cannot determine champion');
                return null;
            }

            console.log('Champion:', champion, 'Runner up:', runnerUp);

            // æŸ¥æ‰¾æ‰€æœ‰åŠå†³ï¼ˆç”¨äºç¡®å®šå­£å†›ï¼‰- æ”¯æŒå¤šç§æ ¼å¼
            console.log('===== DEBUG: All completed matches roundNumbers =====');
            completedMatches.forEach(m => {
                console.log(`Match ${m.id}: roundNumber="${m.roundNumber}", p1=${m.player1Name}, p2=${m.player2Name}`);
            });
            
            const semiFinals = completedMatches.filter(m => {
                const r = m.roundNumber || '';
                const isSemi = r.includes('åŠ') || r.toLowerCase().includes('semi') || r.includes('å‡†å†³') || r.includes('4å¼º') || r.includes('åŠå†³èµ›') || r.includes('åˆèµ›');
                console.log('Checking match for semi:', m.id, m.roundNumber, 'isSemi:', isSemi);
                return isSemi;
            });

            console.log('===== Semi-finals found:', semiFinals.length);
            semiFinals.forEach((semi, i) => {
                console.log(`Semi ${i+1}:`, { p1: semi.player1Name, p2: semi.player2Name, scores: semi.scores });
            });

            console.log('===== Processing semi-finals for third places =====');

            // é“œç‰Œèµ›
            const bronzeMatch = completedMatches.find(m => (m.roundNumber || '').includes('é“œç‰Œ'));

            if (bronzeMatch) {
                let bP1Total = bronzeMatch.player1Total || 0;
                let bP2Total = bronzeMatch.player2Total || 0;

                if ((bP1Total === 0 && bP2Total === 0) && bronzeMatch.scores) {
                    try {
                        const scores = JSON.parse(bronzeMatch.scores);
                        scores.forEach(s => {
                            if (s.p1 > s.p2) bP1Total++;
                            else if (s.p2 > s.p1) bP2Total++;
                        });
                    } catch (e) { }
                }

                if (bP1Total > bP2Total) {
                    thirdPlace = bronzeMatch.player1Name;
                    thirdPlaces = [bronzeMatch.player1Name];
                } else if (bP2Total > bP1Total) {
                    thirdPlace = bronzeMatch.player2Name;
                    thirdPlaces = [bronzeMatch.player2Name];
                }
            } else if (semiFinals.length > 0) {
                console.log('===== Processing', semiFinals.length, 'semifinals for third places');
                // æ²¡æœ‰é“œç‰Œèµ›æ—¶ï¼Œä½¿ç”¨æ‰€æœ‰åŠå†³è¾“çš„ä¸¤é˜Ÿä½œä¸ºå­£å†›
                for (const semi of semiFinals) {
                    let sP1Total = 0;
                    let sP2Total = 0;

                    // ä»scoresè®¡ç®—æ€»åˆ†
                    if (semi.scores) {
                        try {
                            const scores = JSON.parse(semi.scores);
                            console.log('Semi scores:', semi.player1Name, 'vs', semi.player2Name, scores);
                            scores.forEach(s => {
                                if (s.p1 > s.p2) sP1Total++;
                                else if (s.p2 > s.p1) sP2Total++;
                            });
                            console.log('Semi totals:', sP1Total, 'vs', sP2Total);
                        } catch (e) { }
                    }

                    console.log('Semi match:', semi.player1Name, sP1Total, 'vs', semi.player2Name, sP2Total);
                    console.log('Winner is:', sP1Total > sP2Total ? semi.player1Name : (sP2Total > sP1Total ? semi.player2Name : 'tie'));
                    
                    console.log('===== DEBUG: Adding third place =====');
                    console.log('Condition 1 (player1 wins): sP1Total=' + sP1Total + ', sP2Total=' + sP2Total + ', result=' + (sP1Total > sP2Total && sP1Total > 0));
                    console.log('Condition 2 (player2 wins): sP2Total=' + sP2Total + ', sP1Total=' + sP1Total + ', result=' + (sP2Total > sP1Total && sP2Total > 0));

                    // è¾“çš„ä¸€æ–¹åŠ å…¥å­£å†›åˆ—è¡¨ï¼ˆå¿½ç•¥0-0çš„æ¯”åˆ†ï¼‰
                    if (sP1Total > sP2Total && sP1Total > 0) {
                        console.log('Adding loser (player2 won):', semi.player2Name);
                        if (!thirdPlaces.includes(semi.player2Name)) {
                            thirdPlaces.push(semi.player2Name);
                            console.log('Added third place:', semi.player2Name);
                        }
                    }
                    if (sP2Total > sP1Total && sP2Total > 0) {
                        console.log('Adding loser (player1 won):', semi.player1Name);
                        if (!thirdPlaces.includes(semi.player1Name)) {
                            thirdPlaces.push(semi.player1Name);
                            console.log('Added third place:', semi.player1Name);
                        }
                    }
                }
            }

            console.log('===== Final thirdPlaces array:', thirdPlaces);

            console.log('Third place:', thirdPlace);
            console.log('Third places (array):', thirdPlaces);

            if (!champion) return null;

            const result = {
                champion: champion || '-',
                runnerUp: runnerUp || '-',
                thirdPlace: thirdPlace || '-',
                thirdPlaces: thirdPlaces.length > 0 ? thirdPlaces : null,
                _debug: {
                    semiFinalsCount: semiFinals.length,
                    semiFinals: semiFinals.map(s => ({ id: s.id, round: s.roundNumber, p1: s.player1Name, p2: s.player2Name })),
                    thirdPlacesRaw: thirdPlaces
                }
            };
            console.log('===== FINAL RESULT:', result);
            return result;
        }

        function getRoundOrder(roundNumber) {
            if (!roundNumber) return 999;
            if (roundNumber.includes('å†³èµ›') || roundNumber.includes('Final')) return 1;
            if (roundNumber.includes('åŠå†³') || roundNumber.includes('Semi')) return 2;
            if (roundNumber.includes('1/4') || roundNumber.includes('Quarter')) return 3;
            if (roundNumber.includes('1/8') || roundNumber.includes('1/8')) return 4;
            return 5;
        }

        // ========== å…¬å‘Šç®¡ç† ==========
        function showAnnouncementModal(id = null) {
            document.getElementById('announcement-modal').classList.add('show');
            document.getElementById('announcement-modal-title').textContent = id ? 'ç¼–è¾‘å…¬å‘Š' : 'æ·»åŠ å…¬å‘Š';
            document.getElementById('announcement-form').reset();
            document.getElementById('announcement-id').value = id || '';
            if (id) {
                fetch(`${API_BASE}/announcements/${id}`).then(r => r.json()).then(a => {
                    document.getElementById('announcement-title').value = a.title;
                    document.getElementById('announcement-type').value = a.type || 'news';
                    document.getElementById('announcement-content').value = a.content || '';
                    document.getElementById('announcement-published').checked = a.isPublished !== false;
                });
            }
        }

        async function editAnnouncement(id) { showAnnouncementModal(id); }

        async function deleteAnnouncement(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å…¬å‘Šå—ï¼Ÿ')) {
                await fetch(`${API_BASE}/announcements/${id}`, { method: 'DELETE' });
                showHome();
            }
        }

        document.getElementById('announcement-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const id = document.getElementById('announcement-id').value;
            const announcement = {
                title: document.getElementById('announcement-title').value,
                type: document.getElementById('announcement-type').value,
                content: document.getElementById('announcement-content').value,
                isPublished: document.getElementById('announcement-published').checked
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_BASE}/announcements/${id}` : `${API_BASE}/announcements`;

            await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(announcement)
            });

            closeModal('announcement-modal');
            if (currentAnnouncementId) {
                showAnnouncementDetail(currentAnnouncementId);
            } else {
                showHome();
            }
        });

        function toggleMatchDetail(matchId) {
            const detailDiv = document.getElementById('match-detail-' + matchId);
            if (detailDiv) {
                detailDiv.style.display = detailDiv.style.display === 'none' ? 'block' : 'none';
            }
        }

        function formatDateTime(dateStr) {
            if (!dateStr) return '-';
            const d = new Date(dateStr);
            const date = d.toLocaleDateString();
            const time = d.toTimeString().slice(0, 5);
            return `${date} ${time}`;
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('show');
        }

        // åˆå§‹åŒ–
        loadHomeData();
    </script>
</body>

</html>